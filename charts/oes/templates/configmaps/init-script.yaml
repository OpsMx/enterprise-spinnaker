{{- if not .Values.prefersecrets -}}
apiVersion: v1
kind: ConfigMap
metadata:
  name: replace-script-cm
data:
  init-script.sh: |
    #!/bin/bash
    echo "Running init script..."
    cd /secrets/
    for file in *; do
       if [ "$file" = "gate.yml" ]; then
         echo "Copying Gate config"
         cp "$file" "/opt/spinnaker/config/$file"
       elif [ "$file" = "platform-local.yml" ]; then
         echo "Copying Platform config"
         cp "$file" "/opsmx/conf/$file"
       elif [ "$file" = "app-config.yml" ]; then
         echo "Copying Datascience first config(app-config.yml)"
         cp "$file" "/home/ubuntu/datascience/app_config.yaml"
       elif [ "$file" = "minio-credentials" ]; then
         echo "Copying Datascience last config(minio-credentials)"
         cp "$file" "/home/ubuntu/.aws/credentials"
       else 
         echo "No matching file found"
       fi
    done

     export redispassword="password"

    find / -type f \( -name "*.yml" -o -name "*.yaml" \) -not -path "/secrets/*" -exec sed -i 's/encrypted:postgres:postgres/networks123/g' {} \;
    find / -type f \( -name "*.yml" -o -name "*.yaml" \) -not -path "/secrets/*" -exec sed -i 's/encrypted:ldappassword:ldappassword/opsmxadmin123/g' {} \;
    find / -type f \( -name "*.yml" -o -name "*.yaml" \) -not -path "/secrets/*" -exec sed -i 's/encrypted:rabbitmq:rabbitmq/Networks123/g' {} \;
    find / -type f \( -name "*.yml" -o -name "*.yaml" \) -not -path "/secrets/*" -exec sed -i "s/encrypted:redis:redis/$redispassword/g" {} \;
  
    echo "Update completed."
{{- end -}}

